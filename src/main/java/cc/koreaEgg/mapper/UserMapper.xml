<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cc.koreaEgg.mapper.UserMapper">

    <!-- USER TABLE -->
    <select id="selectUserByName" resultType="User">
        SELECT *
        FROM USER
        WHERE user_name LIKE CONCAT('%',#{userName},'%')
    </select>

    <!--TODO AN 관리자용-->
    <select id="selectAllUser" parameterType="map" resultType="User">
        SELECT *
        FROM USER
        WHERE 1=1
        <if test="status neq null">
            AND status = #{status}
        </if>
        <if test="userName neq null">
            AND user_name LIKE CONCAT('%',#{userName},'%')
        </if>
        <if test="shopName neq null">
            AND shop_name LIKE CONCAT('%',#{shopName},'%')
        </if>
        ORDER BY id desc
        <if test="limit neq null">LIMIT <if test="offset neq null">#{offset},</if> #{limit}</if>
    </select>

    <!--TODO AN 유저등록 UserServiceTest 테스트 만들어놈-->
    <insert id="createUser" parameterType="User">
      INSERT INTO USER (user_id, user_name, pwd, mobile, shop_name, post_num, address, address_detail, shop_tel, profile_image, longitude, latitude, reg_date)
      VALUES (#{userId},#{userName},#{pwd},#{mobile},#{shopName},#{postNum},#{address},#{addressDetail},#{shopTel},#{profileImage},#{longitude},#{latitude},NOW())
    </insert>

    <select id="selectUserById" parameterType="long">
      SELECT * FROM USER WHERE id = #{id}
    </select>

    <select id="selectUserByUserId" parameterType="map" resultType="user">
        SELECT * FROM USER WHERE user_id = #{userId} LIMIT 1
    </select>

      <!--TODO AN 비밀번호 찾기용-->
    <update id="updateUserPwd">
        UPDATE USER
        SET pwd = #{pwd}
        WHERE id = #{id}
    </update>

    <update id="updateUser" parameterType="User">
        UPDATE USER
        SET role = #{role}
        , status = #{status}
        , user_name = #{userName}
        , pwd = #{pwd}
        , mobile = #{mobile}
        , shop_name = #{shopName}
        , post_num = #{postNum}
        , address = #{address}
        , address_detail = #{addressDetail}
        , shop_tel = #{shopTel}
        , profile_image = #{profileImage}
        , longitude = #{longitude}
        , latitude = #{latitude}
        , update_date = NOW()
        WHERE id = #{id}
    </update>

    <!--TODO AN 유저탈퇴 개인정보만 지우고 status값만 off로 변경?-->
    <update id="deleteUser" parameterType="long">
        UPDATE USER
        SET status = 9
        WHERE id = #{id}
    </update>

    <!-- USER ROLE REQ TABLE -->
    <insert id="createUserRoleReq">
        /*TODO AN 유저 등급 변경 userId deposit afterRole 만 입력될수있게? expireDate도 계산해야하나? USER테이블의 ROLE도 변경해야함 */
        INSERT INTO USER_ROLE_REQ (user_id, status, role, req_name, deposit, reg_date)
        VALUES (#{userId},0,#{role},#{reqName},#{deposit},NOW())
    </insert>

    <select id="selectAllUserRoleReq" parameterType="map" resultType="userRoleReq">
        /*TODO AN 전체 히스토리 가져오기*/
        SELECT * FROM USER_ROLE_REQ
        WHERE 1=1
        <if test="userId neq null">
            AND user_id = #{userId}
        </if>
        <if test="status neq null">
            AND status = #{status}
        </if>
        <if test="reqName neq null">
            AND req_name like concat('%',#{userId},'%')
        </if>
        <if test="startDate neq null">
            AND reg_date &gt;= #{startDate}
        </if>
        <if test="endDate neq null">
            AND reg_date &lt;= #{endDate}
        </if>
        order by id desc
    </select>

    <update id="updateUserRoleReq">
        UPDATE USER_ROLE_REQ
        SET status = #{status}
        , role = #{role}
        , deposit = #{deposit}
        , update_date = NOW()
        , expire_date = DATE_ADD(NOW(),INTERVAL 1,YEAR)
    </update>
    
    <select id="selectUserRoleExp">
        /* TODO AN 한달이내에 만료되는 계정확인 관리자 확인용*/
    </select>

    <select id="selectUserRoleExpMonth">
        /* TODO AN 한달뒤에 만료되는 계정확인 매일 10시쯤 스케쥴 돌려서 문자보낼예정?*/
    </select>
    
    
    

</mapper>